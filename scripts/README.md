# Protobuf code

## Generating code from .proto files

```commandline
scripts/generate-proto.sh
```

This command builds and runs two separate docker containers that generate protobuf code
using toolchains compatible with protobuf==3.19.6 and protobuf==5.29.4 (effectively protobuf 4+).

We run the generation tools in a docker container, to ensure specific versions: grpcio-tools
and Python in particular.

## Compatibility layer

The generated code lands in the following directories:

Protobuf 3:

* `src/neptune_api/proto/protobuf_v3`
* `src/neptune_retrieval_api/proto/protobuf_v3`

Protobuf 4+

* `src/neptune_api/proto/protobuf_v4plus`
* `src/neptune_retrieval_api/proto/protobuf_v4plus`

There is a simple compatibility layer in `neptune_api/proto/__init__.py` and
`neptune_retrieval_api/proto/__init__.py` that loads the correct module based on
the installed `protobuf` version.

The `.pyi` files in the `proto` directories use the v3 versions, to minimize potential
compatibility risks. It is an arbitrary choice. You can point your IDE to the v4+
version if you prefer.

# Why keep two versions?

* We want to have as broad range of compatibility as possible.
* Version 4+ uses upb, which is a more efficient serialization format.
* We cannot be sure whether the code generated by old grpcio will always take advantage
  of changes introduced in newer protobuf versions.
